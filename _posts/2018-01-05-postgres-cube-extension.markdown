---
layout: post
title:  "Postgres CUBE extension"
date:   2018-01-05 12:28:41 +0100
categories: postgres
toc: true
---
* TOC
{:toc}

## Similar things
Imagine, you want to understand how similar are some items to each other. And this could be anything - two items on the ecommerce site or two videos etc. But to see how similar two things are, we need to find some way to compare them to each other. One way to do that is to represent your items through [embeddings]{:target="_blank"} in some high-dimensional space. 

In practice, it means that every item will be represented by some vector. E.g. like that:

{% highlight matlab %}
item1 = [-1.429; -1.080;  0.0160; 0.810; -0.382; -0.986; -0.898; -0.723; -1.179; -0.391]
item2 = [-0.218;  1.681; -0.0125; 0.235; -0.209;  0.509;  0.553; -0.373; -0.511;  0.212]
item3 = [-0.696;  1.352;  0.2413; 1.202;  0.267; -0.688; -1.197;  0.363;  0.681; -0.578]
{% endhighlight %}

To see how items are related, we can simply find equlidean distance between these representations:
{% highlight matlab %}
norm(item1 - item2) = 3.8372
norm(item1 - item3) = 3.4537
norm(item2 - item3) = 2.9400
{% endhighlight %}

So without knowing much about these items, we can already see that item2 and item3 are more similar, and item1 is closer to item3 than to item2. 

Okay, so now we know how to understand relationship between items. But what about storing these embeddings somewhere. 

## CUBE extesion
One possibility is to store them in relational database. Here we are looking at Postgres (because it's [awesome]{:target="_blank"}, if you had doubts). There is a [cube extension], that allows, among some other things, to store n-dimensional data structures and even find nearest neighbours based on distance between them.

Main idea is to have a `cube` object that will be based on `array` in our case. We will create a table of the following structure and fill it with data from the previous example:
{% highlight sql %}
CREATE TABLE item_embeddings (item_id INT, emb_vector CUBE);
INSERT INTO item_embeddings VALUES
  (1, cube(array[-1.429, -1.080,  0.0160, 0.810, -0.382, -0.986, -0.898, -0.723, -1.179, -0.391])), 
  (2, cube(array[-0.218,  1.681, -0.0125, 0.235, -0.209,  0.509,  0.553, -0.373, -0.511,  0.212])), 
  (3, cube(array[-0.696,  1.352,  0.2413, 1.202,  0.267, -0.688, -1.197,  0.363,  0.681, -0.578]))
{% endhighlight %}

## Finding similar items
And to 
{% highlight sql %}
SELECT item_id, (SELECT emb_vector FROM item_embeddings WHERE item_id = 3) <-> emb_vector AS distance 
  FROM item_embeddings 
 ORDER BY 2 ASC;
{% endhighlight %}
{% highlight shell %}
+-----------+---------------+
| item_id   | distance      |
|-----------+---------------|
| 3         | 0.0           |
| 2         | 2.94019955785 |
| 1         | 3.45394095057 |
+-----------+---------------+
{% endhighlight %}
### Couple of items
### Million items
### Couple of millions
## Trying approximation
## Conclusion



Version
``` sql
select version()
+--------------------------------------------------------------------------------------------------+
| version                                                                                          |
|--------------------------------------------------------------------------------------------------|
| PostgreSQL 10.1 on x86_64-pc-linux-gnu, compiled by gcc (Debian 6.3.0-18) 6.3.0 20170516, 64-bit |
+--------------------------------------------------------------------------------------------------+
```
``` sql
create extension cube;

CREATE TABLE item_embeddings_csv (item_id int, 
e1  float, e2  float, e3  float, e4  float, e5  float, e6  float, e7  float, e8  float, e9  float, e10 float, 
e11 float, e12 float, e13 float, e14 float, e15 float, e16 float, e17 float, e18 float, e19 float, e20 float, 
e21 float, e22 float, e23 float, e24 float, e25 float, e26 float, e27 float, e28 float, e29 float, e30 float, 
e31 float, e32 float, e33 float, e34 float, e35 float, e36 float, e37 float, e38 float, e39 float, e40 float, 
e41 float, e42 float, e43 float, e44 float, e45 float, e46 float, e47 float, e48 float, e49 float, e50 float, 
e51 float, e52 float, e53 float, e54 float, e55 float, e56 float, e57 float, e58 float, e59 float, e60 float, 
e61 float, e62 float, e63 float, e64 float, e65 float, e66 float, e67 float, e68 float, e69 float, e70 float, 
e71 float, e72 float, e73 float, e74 float, e75 float, e76 float, e77 float, e78 float, e79 float, e80 float, 
e81 float, e82 float, e83 float, e84 float, e85 float, e86 float, e87 float, e88 float, e89 float, e90 float);

\copy item_embeddings_csv FROM '/Users/elias.nema/git/relevance/kingsman/models/active_ie.csv'  DELIMITER ',' CSV
```
# The third

``` sh
postgres> select count(*) from item_emb_csv;
+---------+
| count   |
|---------|
| 1199658 |
+---------+

postgres> analyze item_emb_csv;
ANALYZE
Time: 0.896s

postgres> create table item_embeddings (item_id int, vector cube);

postgres> insert into item_embeddings select item_id,cube(array[e1,e2,e3,e4,e5,e6,e7,e8,e9,e10,e11,e12,e13,e14,e15,e16,e17,e18,e19,e20,e21,e22,e23,e24,e25,e26,e27,e28,e29,e30,e31,e32,e33,e34,e35,e36,e37,e
          38,e39,e40,e41,e42,e43,e44,e45,e46,e47,e48,e49,e50,e51,e52,e53,e54,e55,e56,e57,e58,e59,e60,e61,e62,e63,e64,e65,e66,e67,e68,e69,e70,e71,e72,e73,e74,e75,e76,e77,e78,e79,e80,e81,e82,e83,e84,e85,e86
          ,e87,e88,e89,e90]) from item_emb_csv;
INSERT 0 1199658
Time: 11.548s (11 seconds)
postgres> analyze item_embeddings;
ANALYZE
Time: 1.989s (a second)
postgres> select * from item_embeddings order by cube(array[-1.429396629333496,-1.0800886154174805,0.016983360052108765,0.8100804686546326,-0.3821883797645569,-0.9869611263275146,-0.8983392119407654,-0.72
          33108282089233,-1.1799477338790894,-0.3910001516342163,-0.4496285319328308,-0.9205198884010315,0.3329625129699707,0.16709201037883759,-0.32186752557754517,-0.3776169419288635,0.9535160660743713,
          -0.46631839871406555,-0.9827753305435181,-0.23059944808483124,-0.16175822913646698,1.1474850177764893,-0.45223262906074524,0.26880425214767456,-0.20183296501636505,-1.273923635482788,-1.45204544
          06738281,-1.6257303953170776,-0.8976568579673767,0.3239484131336212,0.09839248657226562,-0.32506126165390015,0.3147737383842468,0.3601040840148926,1.2253775596618652,1.1473376750946045,0.2187643
          4981822968,0.08535249531269073,0.5321782827377319,-0.9369210004806519,-0.041441041976213455,0.08755964040756226,-0.3156392574310303,-0.21885186433792114,1.6812622547149658,-0.012522578239440918,
          0.23514816164970398,-0.2094845473766327,0.5095798373222351,0.5535487532615662,-0.37340009212493896,-0.5118032693862915,0.21270844340324402,0.20315015316009521,-0.2860109806060791,0.3482474684715
          271,-1.1423231363296509,0.6251248121261597,0.30866846442222595,-0.3911898732185364,-0.7458918690681458,-1.1178058385849,1.0101838111877441,1.4073526859283447,-0.6966542601585388,1.35284101963043
          21,0.24139447510242462,1.202555537223816,0.26691290736198425,0.08506130427122116,-0.688648521900177,-1.197743535041809,0.36319413781166077,0.6805375814437866,-0.5782361626625061,-0.9213697910308
          838,0.31544339656829834,-0.5080110430717468,-0.15731993317604065,-0.6120206713676453,0.4255205988883972,-0.3019621968269348,-1.0332316160202026,0.6209618449211121,-0.42759597301483154,0.68357586
          86065674,-0.3987412750720978,-0.5011864304542542,-0.3090435266494751,-0.09834538400173187]) <-> vector asc limit 10;
+-----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
| item_id   | vector                                                                                                                                                                                        
|-----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
| 1         | (-1.4293966293335, -1.08008861541748, 0.0169833600521088, 0.810080468654633, -0.382188379764557, -0.986961126327515, -0.898339211940765, -0.723310828208923, -1.17994773387909, -0.39100015163
| 1570193   | (-1.52410984039307, -1.22949028015137, -0.19624088704586, 0.741328001022339, -0.579791963100433, -1.09340727329254, -1.17813634872437, -0.966721296310425, -1.4402437210083, -0.46416696906089
| 1079939   | (-1.54126644134521, -1.25655329227448, -0.234864935278893, 0.72887396812439, -0.615586400032043, -1.11268925666809, -1.22881960868835, -1.01081335544586, -1.48739457130432, -0.47742059826850
| 622013    | (-1.45812726020813, -1.43305480480194, -0.286666035652161, 0.742514133453369, -0.601331651210785, -1.0898711681366, -1.40508770942688, -0.862579047679901, -1.6496570110321, -0.56777703762054
| 833038    | (-1.38374185562134, -1.68211627006531, 0.109135702252388, 0.814811766147614, -1.16279661655426, -0.933576226234436, -0.793501973152161, -0.896188855171204, -1.73902320861816, -0.608343243598
| 1605823   | (-1.60604178905487, -1.33095455169678, -0.0174886882305145, 0.952862679958344, -0.586605131626129, -1.21187329292297, -1.13921058177948, -1.03617930412292, -1.39832079410553, -0.175434947013
| 1310906   | (-1.11108350753784, -1.0072238445282, -0.307974815368652, 0.359968245029449, -0.625868082046509, -1.07872521877289, -1.334712266922, -0.595451712608337, -1.54082369804382, -0.702927052974701
| 619646    | (-1.90957200527191, -1.33467578887939, 0.514744102954865, 1.05396091938019, -0.348787486553192, -1.06412422657013, -1.16105818748474, -0.595287919044495, -1.92011308670044, -0.86499607563018
| 1795854   | (-0.649678349494934, -0.897190690040588, -0.26180100440979, 0.43856218457222, -0.882052302360535, -1.22166228294373, -0.850410878658295, -0.124631226062775, -0.76722377538681, -0.26512864232
| 2002809   | (-1.04451811313629, -1.36315369606018, 0.132547095417976, 0.710687875747681, -1.22742640972137, -0.788083612918854, -0.728577733039856, -0.388570666313171, -1.47935140132904, -0.502618670463
+-----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
SELECT 10
Time: 1.356s (a second)
postgres> explain analyze select * from item_embeddings order by cube(array[-1.429396629333496,-1.0800886154174805,0.016983360052108765,0.8100804686546326,-0.3821883797645569,-0.9869611263275146,-0.898339
          2119407654,-0.7233108282089233,-1.1799477338790894,-0.3910001516342163,-0.4496285319328308,-0.9205198884010315,0.3329625129699707,0.16709201037883759,-0.32186752557754517,-0.3776169419288635,0.9
          535160660743713,-0.46631839871406555,-0.9827753305435181,-0.23059944808483124,-0.16175822913646698,1.1474850177764893,-0.45223262906074524,0.26880425214767456,-0.20183296501636505,-1.27392363548
          2788,-1.4520454406738281,-1.6257303953170776,-0.8976568579673767,0.3239484131336212,0.09839248657226562,-0.32506126165390015,0.3147737383842468,0.3601040840148926,1.2253775596618652,1.1473376750
          946045,0.21876434981822968,0.08535249531269073,0.5321782827377319,-0.9369210004806519,-0.041441041976213455,0.08755964040756226,-0.3156392574310303,-0.21885186433792114,1.6812622547149658,-0.012
          522578239440918,0.23514816164970398,-0.2094845473766327,0.5095798373222351,0.5535487532615662,-0.37340009212493896,-0.5118032693862915,0.21270844340324402,0.20315015316009521,-0.2860109806060791
          ,0.3482474684715271,-1.1423231363296509,0.6251248121261597,0.30866846442222595,-0.3911898732185364,-0.7458918690681458,-1.1178058385849,1.0101838111877441,1.4073526859283447,-0.6966542601585388,
          1.3528410196304321,0.24139447510242462,1.202555537223816,0.26691290736198425,0.08506130427122116,-0.688648521900177,-1.197743535041809,0.36319413781166077,0.6805375814437866,-0.5782361626625061,
          -0.9213697910308838,0.31544339656829834,-0.5080110430717468,-0.15731993317604065,-0.6120206713676453,0.4255205988883972,-0.3019621968269348,-1.0332316160202026,0.6209618449211121,-0.427595973014
          83154,0.6835758686065674,-0.3987412750720978,-0.5011864304542542,-0.3090435266494751,-0.09834538400173187]) <=> vector asc limit 10;
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
| QUERY PLAN                                                                                                                                                                                                
|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
| Limit  (cost=160885.97..160886.00 rows=10 width=740) (actual time=1438.489..1438.492 rows=10 loops=1)                                                                                                     
|   ->  Sort  (cost=160885.97..163885.12 rows=1199660 width=740) (actual time=1438.487..1438.489 rows=10 loops=1)                                                                                           
|         Sort Key: (('(-1.4293966293335, -1.08008861541748, 0.0169833600521088, 0.810080468654633, -0.382188379764557, -0.986961126327515, -0.898339211940765, -0.723310828208923, -1.17994773387909, -0.39
|         Sort Method: top-N heapsort  Memory: 42kB                                                                                                                                                         
|         ->  Seq Scan on item_embeddings  (cost=0.00..134961.75 rows=1199660 width=740) (actual time=0.042..1169.475 rows=1199658 loops=1)                                                                 
| Planning time: 0.102 ms                                                                                                                                                                                   
| Execution time: 1438.523 ms                                                                                                                                                                               
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
postgres> CREATE INDEX ON item_embeddings USING gist ( vector );
CREATE INDEX
Time: 279.722s (4 minutes)
postgres> analyze item_embeddings;
ANALYZE
Time: 4.004s (4 seconds)
postgres> SELECT pg_relation_filepath(oid), relpages FROM pg_class WHERE relname = 'item_embeddings';
+------------------------+------------+
| pg_relation_filepath   | relpages   |
|------------------------+------------|
| base/12994/16479       | 119966     |
+------------------------+------------+
SELECT 1
Time: 0.003s
postgres> explain analyze select * from item_embeddings order by cube(array[-1.429396629333496,-1.0800886154174805,0.016983360052108765,0.8100804686546326,-0.3821883797645569,-0.9869611263275146,-0.898339
          2119407654,-0.7233108282089233,-1.1799477338790894,-0.3910001516342163,-0.4496285319328308,-0.9205198884010315,0.3329625129699707,0.16709201037883759,-0.32186752557754517,-0.3776169419288635,0.9
          535160660743713,-0.46631839871406555,-0.9827753305435181,-0.23059944808483124,-0.16175822913646698,1.1474850177764893,-0.45223262906074524,0.26880425214767456,-0.20183296501636505,-1.27392363548
          2788,-1.4520454406738281,-1.6257303953170776,-0.8976568579673767,0.3239484131336212,0.09839248657226562,-0.32506126165390015,0.3147737383842468,0.3601040840148926,1.2253775596618652,1.1473376750
          946045,0.21876434981822968,0.08535249531269073,0.5321782827377319,-0.9369210004806519,-0.041441041976213455,0.08755964040756226,-0.3156392574310303,-0.21885186433792114,1.6812622547149658,-0.012
          522578239440918,0.23514816164970398,-0.2094845473766327,0.5095798373222351,0.5535487532615662,-0.37340009212493896,-0.5118032693862915,0.21270844340324402,0.20315015316009521,-0.2860109806060791
          ,0.3482474684715271,-1.1423231363296509,0.6251248121261597,0.30866846442222595,-0.3911898732185364,-0.7458918690681458,-1.1178058385849,1.0101838111877441,1.4073526859283447,-0.6966542601585388,
          1.3528410196304321,0.24139447510242462,1.202555537223816,0.26691290736198425,0.08506130427122116,-0.688648521900177,-1.197743535041809,0.36319413781166077,0.6805375814437866,-0.5782361626625061,
          -0.9213697910308838,0.31544339656829834,-0.5080110430717468,-0.15731993317604065,-0.6120206713676453,0.4255205988883972,-0.3019621968269348,-1.0332316160202026,0.6209618449211121,-0.427595973014
          83154,0.6835758686065674,-0.3987412750720978,-0.5011864304542542,-0.3090435266494751,-0.09834538400173187]) <-> vector asc limit 10;
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
| QUERY PLAN                                                                                                                                                                                                
|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
| Limit  (cost=0.41..12.28 rows=10 width=740) (actual time=113.535..14707.274 rows=10 loops=1)                                                                                                              
|   ->  Index Scan using item_embeddings_vector_idx on item_embeddings  (cost=0.41..1423985.55 rows=1199657 width=740) (actual time=113.533..14707.262 rows=10 loops=1)                                     
|         Order By: (vector <-> '(-1.4293966293335, -1.08008861541748, 0.0169833600521088, 0.810080468654633, -0.382188379764557, -0.986961126327515, -0.898339211940765, -0.723310828208923, -1.17994773387
| Planning time: 0.835 ms                                                                                                                                                                                   
| Execution time: 14707.719 ms                                                                                                                                                                              
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
EXPLAIN
Time: 14.719s (14 seconds)
postgres> \d item_embeddings
+----------+---------+-------------+
| Column   | Type    | Modifiers   |
|----------+---------+-------------|
| item_id  | integer |             |
| vector   | cube    |             |
+----------+---------+-------------+
Indexes:
    "item_embeddings_vector_idx" gist (vector)

Time: 0.011s
postgres> drop index item_embeddings_vector_idx
DROP INDEX
Time: 0.108s
postgres> CREATE INDEX ON item_embeddings  ( vector );
CREATE INDEX
Time: 19.553s (19 seconds)
postgres> analyze item_embeddings;
postgres> explain analyze select * from item_embeddings order by cube(array[-1.429396629333496,-1.0800886154174805,0.016983360052108765,0.8100804686546326,-0.3821883797645569,-0.9869611263275146,-0.898339
          2119407654,-0.7233108282089233,-1.1799477338790894,-0.3910001516342163,-0.4496285319328308,-0.9205198884010315,0.3329625129699707,0.16709201037883759,-0.32186752557754517,-0.3776169419288635,0.9
          535160660743713,-0.46631839871406555,-0.9827753305435181,-0.23059944808483124,-0.16175822913646698,1.1474850177764893,-0.45223262906074524,0.26880425214767456,-0.20183296501636505,-1.27392363548
          2788,-1.4520454406738281,-1.6257303953170776,-0.8976568579673767,0.3239484131336212,0.09839248657226562,-0.32506126165390015,0.3147737383842468,0.3601040840148926,1.2253775596618652,1.1473376750
          946045,0.21876434981822968,0.08535249531269073,0.5321782827377319,-0.9369210004806519,-0.041441041976213455,0.08755964040756226,-0.3156392574310303,-0.21885186433792114,1.6812622547149658,-0.012
          522578239440918,0.23514816164970398,-0.2094845473766327,0.5095798373222351,0.5535487532615662,-0.37340009212493896,-0.5118032693862915,0.21270844340324402,0.20315015316009521,-0.2860109806060791
          ,0.3482474684715271,-1.1423231363296509,0.6251248121261597,0.30866846442222595,-0.3911898732185364,-0.7458918690681458,-1.1178058385849,1.0101838111877441,1.4073526859283447,-0.6966542601585388,
          1.3528410196304321,0.24139447510242462,1.202555537223816,0.26691290736198425,0.08506130427122116,-0.688648521900177,-1.197743535041809,0.36319413781166077,0.6805375814437866,-0.5782361626625061,
          -0.9213697910308838,0.31544339656829834,-0.5080110430717468,-0.15731993317604065,-0.6120206713676453,0.4255205988883972,-0.3019621968269348,-1.0332316160202026,0.6209618449211121,-0.427595973014
          83154,0.6835758686065674,-0.3987412750720978,-0.5011864304542542,-0.3090435266494751,-0.09834538400173187]) <-> vector asc limit 10;
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
| QUERY PLAN                                                                                                                                                                                                
|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
| Limit  (cost=160885.87..160885.89 rows=10 width=740) (actual time=1488.500..1488.503 rows=10 loops=1)                                                                                                     
|   ->  Sort  (cost=160885.87..163885.01 rows=1199657 width=740) (actual time=1488.499..1488.501 rows=10 loops=1)                                                                                           
|         Sort Key: (('(-1.4293966293335, -1.08008861541748, 0.0169833600521088, 0.810080468654633, -0.382188379764557, -0.986961126327515, -0.898339211940765, -0.723310828208923, -1.17994773387909, -0.39
|         Sort Method: top-N heapsort  Memory: 42kB                                                                                                                                                         
|         ->  Seq Scan on item_embeddings  (cost=0.00..134961.71 rows=1199657 width=740) (actual time=0.075..1225.012 rows=1199658 loops=1)                                                                 
| Planning time: 0.133 ms                                                                                                                                                                                   
| Execution time: 1488.528 ms                                                                                                                                                                               
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
EXPLAIN
Time: 1.500s (a second)


```

[embeddings]: https://www.tensorflow.org/versions/master/programmers_guide/embedding
[awesome]: http://www.craigkerstiens.com/2018/01/31/postgres-hidden-gems/#.WnThJWCKxwk.twitter
[cube extension]: https://www.postgresql.org/docs/10/static/cube.html
[]: https://towardsdatascience.com/deep-learning-4-embedding-layers-f9a02d55ac12